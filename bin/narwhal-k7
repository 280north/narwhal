#!/bin/bash

# get the absolute path of the executable
SELF_PATH=$(cd -P -- "$(dirname -- "$0")" && pwd -P) && SELF_PATH=$SELF_PATH/$(basename -- "$0")

# resolve symlinks
while [ -h $SELF_PATH ]; do
	DIR=$(dirname -- "$SELF_PATH")
	SYM=$(readlink $SELF_PATH)
	SELF_PATH=$(cd $DIR && cd $(dirname -- "$SYM") && pwd)/$(basename -- "$SYM")
done

SELF_DIR=`dirname $SELF_PATH`

NARWHAL_HOME=`dirname $SELF_DIR`
NARWHAL="$NARWHAL_HOME/narwhal-k7.js"
NARWHAL_PATH="$NARWHAL_HOME/platforms/k7:$NARWHAL_HOME/platforms/default:$NARWHAL_HOME/lib"
if [ "$JS_PATH" ]; then
    NARWHAL_PATH="$NARWHAL_PATH:$JS_PATH"
fi

RLWRAP=`which rlwrap`

# convert paths for Cygwin
if [[ `uname` == CYGWIN* ]]; then
    NARWHAL_HOME=`cygpath -wp "$NARWHAL_HOME"`
    NARWHAL=`cygpath -wp "$NARWHAL"`
fi

export NARWHAL_HOME
export NARWHAL_PATH

K7="$RLWRAP $HOME/git/k7/k7"

MAIN=$(cd -P -- "$(dirname -- "$1")" && pwd -P) && \
MAIN=$MAIN/$(basename -- "$1" .js)
if [[ `uname` == CYGWIN* ]]; then
    MAIN=`cygpath -wp "$MAIN"`
fi
shift
$K7 $NARWHAL $MAIN "$@"
